{
    "collab_server" : "",
    "contents" : "\nh2dir <- \"/gpfs/group/dxl46/default/private/renan/gits/XCIR_paper/heritability/\"\nldscs <- fread(paste0(h2dir, \"data/ldscs.tsv\"))\n\n# list complete runs\nldscs_done <- ldscs[file.exists(ldsc_output)]\n\n\n\n## LIBS ----------------\nlibrary(data.table)\nlibrary(doMC)\nlibrary(foreach)\n## SETUP ---------------------\nsource(paste0(h2dir, \"/code/functions.R\"))\n\n## PHENOTYPES -----------------\nphenofolder <- \"/gpfs/group/dxl46/default/private/datasets_refs/Hail/hail_2nd_raw\"\nfphenofiles <- list.files(path = phenofolder, pattern = \"20002_.*female.tsv.bgz$\", full.names = T)\nmphenofiles <- list.files(path = phenofolder, pattern = \"20002_.*v3.male.tsv.bgz$\", full.names = T)\nbphenofiles <- list.files(path = phenofolder, pattern = \"20002_.*both_sexes.tsv.bgz$\", full.names = T)\n# create smaller gwas files to read it all at once\nphenof <- mphenofiles\nfor(i in 195:length(phenof)){\n  pfi <- phenof[i]\n  pci <- gsub(\".gwas.imputed.*.bgz\", \"\", basename(pfi))\n  cmd <- paste(\"zcat\", pfi)\n  print(paste(\"Processing\", pci))\n  gwas <- fread(cmd = cmd)\n  gwasX <- gwas[variant %like% \"^X:\"]\n  gwasX[, POS := as.numeric(gsub(\":.*\", \"\", gsub(\"X:\", \"\", variant)))]\n  gwasdt <- gwasX[, list(POS, beta, se)]\n  gwasdt[, Z := (beta/se)^2]\n  oname <- paste0(h2dir, \"/data/gwasx/\", gsub(\".tsv.bgz\", \".tsv\", basename(pfi)))\n  fwrite(gwasdt, file = oname, sep = \"\\t\")\n}\n\nldscs_done <- ldscs_done[ext == \"extori\"]\nfor(i in 1:nrow(ldscs_done))\nld <- fread(ldscs_done[1, ldsc_input])\ngwas <- fread(cmd = paste(\"zcat\", fphenofiles[1]))\nh2 <- ldsc1(gwas = gwas, ldscores = ld)\n\n# With pre-processed gwas files\nld <- fread(ldscs_done[sex == \"female\" & ext == \"extori\" & maxcor == 0.25 & version == 1.1, ldsc_input])\ngwasxdir <- paste0(h2dir, \"/data/gwasx/\")\nfgwas <- list.files(path = gwasxdir, pattern = \"20002_.*female.tsv$\", full.names = T)\ngwasf <- fgwas\nfitl <- vector(\"list\", length(gwasf))\nfor(i in seq_along(gwasf)){\n  gwasi <- fread(gwasf[i])\n  pci <- gsub(\".gwas.imputed.*.tsv\", \"\", basename(gwasf[i]))\n  print(paste(round(i/length(gwasf), 3), pci))\n  fitdat <- merge(gwasi, ld, by = \"POS\")\n  preds <- names(fitdat)[5:ncol(fitdat)]\n  form <- paste(\"Z ~\", paste(preds, collapse = \"+\"))\n  fit <- lm(form, data = fitdat)\n  sfitco <- summary(fit)$coefficients\n  fitdt <- data.table(sfitco, term = rownames(sfitco))\n  fitdt[, phenocode := pci]\n  fitl[[i]] <- fitdt\n}\nfits <- rbindlist(fitl)\n\nsnp_anno    <- fread(paste0(h2dir, \"/data/annotated_snps.tsv\"))\n\nfits[, sex := \"female\"]\n# dat <- merge(ratios[, .(track, N, M_pro = ratio)], fits, by.x = \"track\", by.y = \"term\")\ndat <- fits[!term %like% \"ntercept\"]\nsetnames(dat, \"term\", \"track\")\n\n\n\ntracks   <- unique(dat$track)\ntl <- vector(\"list\", length(tracks))\nfor(k in seq_along(tracks)){\n  trackk <- tracks[k]\n  snpsk <- snp_anno[get(trackk) == 1] #All snp in track\n  # \"Estimate\" are the estimates from the regression and correspond to taus in the paper.\n  tau_counts <- colSums(snpsk[, tracks, with = F]) # Number of snps per overlapping track\n  tau_dt <- data.table(track = names(tau_counts), count = tau_counts)\n  tau_dt <- merge(dat, tau_dt, by = c(\"track\"))\n  #h2 is the sum of all taus across all SNPs overlapping SNPs in the current track\n  # i.e: For each snp in the current track. Find all other overlapping tracks and add their tau. Then sum it all.\n  # ret[, h2 := sum(Estimate^2*count), by = c(\"phenocode\")]\n  ret <- tau_dt[, sum(Estimate^2*count), by = c(\"phenocode\", \"sex\")]\n  tl[[k]] <- ret[, .(track = trackk, sex, phenocode, h2 = V1)]\n}\nh2s <- rbindlist(tl)\nallres <- merge(h2s, phenos_anno, by.x = c(\"phenocode\", \"sex\"), by.y = c(\"code\", \"gender\"))\nallres <- merge(allres, ratios[, .(track, N, M_pro = ratio)], by = \"track\")\nbycols <- c(\"sex\", \"phenocode\")\nallres[, h := sum(h2, na.rm = T), by = bycols]\nallres[, h2_pro := h2/h]\nallres[, enrich := h2_pro/M_pro]\n#allres[, z := dnorm(qnorm(prevalence))]\n#allres[, LDl := Estimate*prevalence*(1-prevalence)/z^2]\n#allres[, h2l := h2*prevalence*(1-prevalence)/z^2]\n#allres[, hl := sum(h2l, na.rm = T), by = bycols]\n#allres[, h2l_pro := h2l/hl]\n#allres[, enrichl := h2l_pro/M_pro]\n\n\np <- ggplot(allres[track %like% \"xcir\"], aes(x = track, y = enrich)) + \n  geom_boxplot(aes(fill = sex)) + \n  theme_bw() +\n  xlab(\"XCI-state\") + ylab(\"Heritability enrichment\") + ggtitle(\"No jackknife\")\nprint(p)\n\n\n",
    "created" : 1599596819002.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1534821525",
    "id" : "AAAE21DA",
    "lastKnownWriteTime" : 1599242182,
    "last_content_update" : 1599242182,
    "path" : "/gpfs/group/dxl46/default/private/renan/gits/XCIR_paper/heritability/code/ddd_LDSC.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 5,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}